<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Pets, cattle and automatic operations with code</title>

	<link rel="stylesheet" href="dist/reset.css">
	<link rel="stylesheet" href="dist/reveal.css">
	<link rel="stylesheet" href="dist/theme/simple.css">
	<link rel="stylesheet" href="presentation/css/terminal.css">
	<link rel="stylesheet" href="custom.css">

	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="plugin/highlight/monokai.css">
	<script src="plugin/highlight/highlight.js"></script>
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<section>
					<h2>Hi, I am Svyat!</h2>

					<aside class="notes">
						<lo>
							<li> Senior SWE at Google, and talk is not related to Google. </li>
							<li> For those how waiting a sign to turn on vide, this is the sign! </li>
						</lo>
					</aside>

				</section>

				<section>
					<img src="./images/svyat_work_timeline.svg" />

					<lo>
						<li> All places had tons of code and there was similar problems. </li>
						<li> I am not in a fancy library team. </li>
						<li> Let's take a look onto examples. </li>
					</lo>
			</section>

				<section>
					<h2> New cpp feature arrived! How to consistently stop use old feature? </h2>

					<aside class="notes">s
						<lo>
							<li>Migration to constexpr string_view constructor.</li>
							<li>Template from c stings and cpp20.</li>
							<li>There are cases, when code do not compile with new standard. But this is for fancy teams. </li>
						</lo>
					</aside>
				</section>

				<section>
					<h2> How to improve API used all over the code? </h2>

					<aside class="notes">
						<lo>
							<li>This argument is never nullptr, let's make it reference?</li>
							<li>I am adding sixth arg, is it time for options struct?</li>
							<li>Both examples above are find & enforce issues.</li>
						</lo>
					</aside>
				</section>

				<section>
					<h2> ~1000 OTel spans constructed from strings literals let's refactor. </h2>
				</section>

				<section>
					<h2> Maybe huge code-bases are corporation disease? </h2>
				</section>

				<section>
					<h2>Linux kernel lines of code</h2>
					<pre><code data-trim data-noescape>
					~/linux$ cloc .
					139223 text files.
					138000 unique files.
					55315 files ignored.

					github.com/AlDanial/cloc  T=107.20 s
					-----------------------------------------------
					Language      files    blank  comment      code
					-----------------------------------------------
					C             38638  3342054  2581107  17414033
					C/cpp Header  23565   705113  1339694   6954666
					Assembly       1337    48551   102434   1862752
				</code></pre>

				</section>

				<section>
					<h2>NodeJS lines of code</h2>
					<pre><code data-trim data-noescape>
						~/node$ cloc .
						42602 text files.
						38366 unique files.
						9832 files ignored.

						github.com/AlDanial/cloc  T=28.45s
						---------------------------------------------
						Language      files   blank  comment     code
						---------------------------------------------
						cpp            3094  254539   240197  2023156
						Perl            619   32748    28272  1784382
						JavaScript    19270  218078   288933  1763057
						C/cpp Header   3987  155374   338166   751333
						C              2104  106491    93472   650332

				</code></pre>

				</section>

				<section>
					<h2> How to make life simpler? </h2>
				</section>

				<section>
					<h2>Let's treat code as cattle!</h2>
					<img src="./images/cattle.webp" />
				</section>

				<section>
					<h2> Find </h2>
					<h2> Fix and enforce </h2>
					<h2> Generate </h2>

				</section>

			</section>

			<section>
				<section>
					<h2>Theory!</h2>
					<img src="./images/theory.webp" />
				</section>

				<section>
					<h2>There are grep, sed and company! Isn't it enoughs?</h2>
				</section>

				<section>
					<h5>std::condition_variable::wait<h5>

							<pre><code class="language-cpp" data-trim data-noescape >
						class Worker {

							void work() {
								std::unique_lock lock{mt_};
								if (condition) {
									cv_.wait(lock);
								}
								...
							}

							std::mutex mt_;
							std::condition_variable cv_;
						};
						</code></pre>
				</section>

				<section>
					<h5>std::condition_variable::wait<h5>

							<pre><code class="language-cpp" data-trim data-noescape data-line-numbers="5">
						class Worker {

							void work() {
								std::unique_lock lock{mt_};
								if (condition) { // <- spurious wake up issue
									cv_.wait(lock);
								}
								...
							}

							std::mutex mt_;
							std::condition_variable cv_;
						};
						</code></pre>
				</section>

				<section>
					<pre><code class="language-bash" data-trim data-noescape>
						grep -rHn --include "*.cc" --include "*.h" 'wait()'
					</code></pre>
				</section>

				<section>
					<h5>Somewhere in forgotten library<h5>
							<pre><code class="language-cpp" data-trim data-noescape >
						void wait() {
							...
						}
						</code></pre>
				</section>

				<section>
					<h5>Or in the code of intern from 3 years ago<h5>
							<pre><code class="language-cpp" data-trim data-noescape >
						int behind_horizons() {
							...
							std::cout << "really useful debug about wait()" << std::endl;
						}
					</code></pre>
				</section>

				<section>
					<h2>And fell to depression<h2>
							<img src="./images/depression.webp" />

				</section>

				<section>
					<h2>Compilation process</h2>
					<div class="r-stack">
						<img class="fragment fade-in-then-out" src="./images/compilation_process_first.svg" />
						<img class="fragment fade-in-then-out" src="./images/compilation_process_second.svg" />
						<img class="fragment fade-in-then-out" src="./images/compilation_process_third.svg" />
						<img class="fragment fade-in-then-out" src="./images/compilation_process_forth.svg" />
						<img class="fragment fade-in-then-out" src="./images/compilation_process_fifth.svg" />
						<img class="fragment fade-in-then-out" src="./images/compilation_process_sixth.svg" />
						<img class="fragment fade-in-then-out" src="./images/compilation_process_end.svg" />
					</div>
				</section>

				<section
					data-background-iframe="https://godbolt.org/z/8WsfzW9n8"
					data-background-interactive>

					<aside class="notes"> class="r-strech"
						<lo>
						</li>Clang AST close to C++ standard, source code and machine readable.</li>
						</lo>
					</aside>


				</section>

				<section>
					<h2>Let's try to use it!</h2>
				</section>
			</section>

			<section>
				<section>
					<h2>Find</h2>
					<img src="./images/find.webp" />
				</section>

				<section>
					<h2>Matcher for wait problem</h2>
					<pre><code class="language-isbl+" data-trim data-noescape data-line-numbers="1|2|3|4|5|6|9">
						m callExpr(
							callee(
								cxxMethodDecl(
									allOf(
										hasName("wait"),
										ofClass(hasName("std::condition_variable")))
									)
							),
							argumentCountIs(1)
						)
					</code></pre>

					<div class="footer">
						<a href="https://clang.llvm.org/docs/LibASTMatchersReference.html" id="noteslink"> [1] Matchers referece</a>
					</div>

					<aside class="notes">
						<p> Clang matchers reference link. And useful links in the footers <p>
					</aside>
				</section>


				<section>
					<h5>Lost exceptions<h5>
							<pre><code class="language-cpp" data-trim data-noescape data-line-numbers>
						try {
							do_something();
						} except {
							eat_exception_and_smile();
						}
						</code></pre>
				</section>


				<section>
					<pre><code language="language-isbl" data-trim data-noescape data-line-numbers="1|2|3|4">
						m cxxCatchStmt(
							unless(
								hasDescendant(
										cxxThrowExpr()
								)
							)
						)
					</code></pre>

					<aside class="notes">
						<lo>
						<li> Next slide is GodBolt live example. </li>
						<li> Locality of matchers. </li>
						<li> Sometimes too declarative and hard to implement. </li>

						</lo>
					</aside>
				</section>

				<section
					data-background-iframe="https://godbolt.org/z/b7jYohM57"
					data-background-interactive>

					<aside class="notes">

						<lo>
							</li>Full screen example, go to viewer tab.</li>
							</li>Not forget about implicit nodes.</li>
						</lo>

					</aside>
				</section>

				<section>
					<h2> How about from the terminal example? </h2>

					<div class="footer">
						<lo>
							<li><a href="https://github.com/feldsherov/pets-cattle-and-code-examples/tree/master/query-example">[0] Github with example code</a></li>
							<li><a href="https://firefox-source-docs.mozilla.org/code-quality/static-analysis/writing-new/clang-query.html">[1] Firefox docs on clang-query</a></li>
						</lo>
					</div>

					<aside class="notes">
						<lo>
							<li>As complex as parsing the code. Complexity guesstimate is 1/3 of compilation.</li>
							<li>Clang query usually used as part of matchers development, not on it's own.</li>
							<li>There is an option to pass matcher from command line, so it is already some compliance tool.</li>
							<li>All examples are available at my Github.</li>
							<li>Firefox docs in footer links.</li>
						</lo>
					</aside>
				</section>

				<section>
					<h2> Conclusion </h2>

					<div style="text-align: left">
						<lo>
							<li class="fragment">  Matchers are nice declarative language to query AST </li>
							<li  class="fragment"> Use clang-query to debug matchers on your code </li>
							<li  class="fragment"> It is possible to forbid usage of anything we can match </li>
						</lo>
					</div>

					<aside class="notes">
						<lo>
							<li>Even though we can use clang query to enforcing, this is not a best tool.</li>
						</lo>
					</aside>
				</section>


			</section>

			<section>
				<section>
					<h2>Fix and enforce</h2>
					<img src="./images/fix.webp" />
				</section>

				<section>
					<h5>Pointer to reference argument<h5>
							<pre><code class="language-cpp" data-trim data-noescape data-line-numbers>
						void AwesomeFunc(SomeObject* object);
						void AwesomeFunc(SomeObject& object);

						int main() {
							SomeObject object;
							AwesomeFunc(&object);
						}
					</code></pre>
				</section>

				<section>
					<h5>Matcher<h5>
							<pre><code class="language-isbl" data-trim data-noescape data-line-numbers>
						m callExpr(
								callee(
									functionDecl(
										hasName("AwesomeFunc")
									)
								),
								hasArgument(
									0, expr(
											hasType(pointerType())
									).bind("argument")
								)
							)
					</code></pre>
				</section>

				<section>
					<h5>Transformation<h5>
							<pre><code class="language-cpp" data-trim data-noescape data-line-numbers>
								changeTo(
									node("argument"),
									transformer::maybeDeref("argument")
								)
					</code></pre>
				</section>

				<section>
					<h5>Interesting part of code<h5>
							<pre><code class="language-cpp" data-trim data-noescape data-line-numbers>
					const std::string ArgId = "arg";
					auto Rule = makeRule(
							callExpr(callee(functionDecl(hasName("AwesomeFunc"))),
												hasArgument(0,
													expr(hasType(pointerType())).bind(ArgId))),
							changeTo(node(ArgId), transformer::maybeDeref(ArgId)));

					Transformer TransformerInstance(
						Rule,
						[&AllChanges](Expected<llvm::MutableArrayRef<AtomicChange>> Changes) {
							AllChanges.insert(
								AllChanges.end(),
								std::make_move_iterator(Changes->begin()),
								std::make_move_iterator(Changes->end()));
					});
					</code></pre>

					<aside class="notes">
						<lo>
							<li>Pay attention on rewrite. Stencil + rewrite to code, not to AST.</li>
							<li>Hard to rewrite to something complex.</li>
						</lo>
					</aside>

				</section>

				<section>
					<h2> Let's make it live! </h2>
					<div class="footer">
						<lo>
							<li><a href="https://github.com/feldsherov/pets-cattle-and-code-examples/tree/master/transform-example"></a></li>
						</lo>
					</div>

					<aside class="notes">
						<lo>
							<li>Link to Github with example.</li>
							<li>We patched llvm clang-extra-tools and added new tool.</li>
							<li>No way for upstream. If you use your build of clang, should be easy to support custom tool </li>
						</lo>
					</aside>
				</section>

				<section>
					<h2> Conclusion </h2>

					<div style="text-align: left">
						<lo>
							<li class="fragment">  Clang-transform like "search and replace" powered by ClangMatchers.  </li>
							<li class="fragment"> Clang-tidy support from the box </li>
							<li class="fragment"> Relatively hard to build the first tool </li>
						</lo>
					</div>
				</section>
			</section>

		</div>
	</div>

	<script src="dist/reveal.js"></script>
	<script src="plugin/notes/notes.js"></script>
	<script src="plugin/markdown/markdown.js"></script>
	<script src="plugin/highlight/highlight.js"></script>
	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,

			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
		});
	</script>
</body>

</html>